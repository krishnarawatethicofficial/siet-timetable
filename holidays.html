<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Holiday Manager</title>
<style>
:root{--bg:#0b0f15;--panel:#121825;--muted:#8aa1b1;--text:#e7eef5;--accent:#5cc8ff;--ok:#4ade80;--warn:#fbbf24;--danger:#fb7185;--card:#0f1522;--shadow:0 10px 30px rgba(0,0,0,.35)}
body.light{--bg:#f7f9fc;--panel:#fff;--muted:#5a6c7f;--text:#17223b;--accent:#3a7afe;--ok:#198754;--warn:#f59e0b;--danger:#dc3545;--card:#fff;--shadow:0 6px 20px rgba(0,0,0,.1)}
body.floral{--bg:#fff1f5;--panel:#ffe5ec;--muted:#a65876;--text:#4c0033;--accent:#d81159;--ok:#74c69d;--warn:#fca311;--danger:#e63946;--card:#ffe5ec;--shadow:0 6px 20px rgba(200,100,150,.15)}
body.sky{--bg:#e0f7fa;--panel:#fff;--muted:#5a7aa5;--text:#12263a;--accent:#00bcd4;--ok:#2ca58d;--warn:#ffb74d;--danger:#ff8a65;--card:#fff;--shadow:0 6px 20px rgba(0,128,255,.15)}
html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:500 16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;transition:background-color .3s,color .3s}
.wrap{max-width:860px;margin:24px auto;padding:0 16px 40px}
header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:18px}
h1{font-size:clamp(20px,3.5vw,28px);margin:0}
.badge{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(32,48,71,.5);background:var(--panel);padding:8px 12px;border-radius:14px;color:var(--muted)}
.controls{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:18px;align-items:center}
label{display:flex;align-items:center;gap:8px;font-size:14px}
select,button,input,textarea{background:var(--panel);color:var(--text);border:1px solid rgba(29,42,63,.4);border-radius:8px;padding:8px 10px;font:500 14px system-ui}
select,button,input{appearance:none}
a.pill,span.pill{display:inline-block;font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(32,48,71,.5);background:var(--panel);color:var(--muted);text-decoration:none}
button{cursor:pointer;transition:box-shadow .2s}
button:hover{box-shadow:0 2px 6px rgba(0,0,0,.15)}
.card{background:var(--card);border:1px solid rgba(29,42,63,.4);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;margin-bottom:18px}
.card>.hd{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:14px 16px;border-bottom:1px solid rgba(29,42,63,.4)}
.card>.bd{padding:16px}
.tag{font-size:12px;padding:4px 8px;border-radius:999px;background:var(--panel);border:1px solid rgba(32,48,71,.5);color:var(--muted)}
.list{margin-top:12px;display:flex;flex-direction:column;gap:8px}
.holiday-item{display:flex;gap:12px;align-items:flex-start;background:var(--panel);border:1px solid rgba(29,42,63,.4);border-radius:8px;padding:10px 12px}
.holiday-main{flex:1}
.holiday-actions{display:flex;gap:8px}
.row{display:flex;gap:8px;flex-wrap:wrap}
.muted{color:var(--muted)}
.hint{font-size:12px;color:var(--muted);margin-top:6px}
.edit-box{display:grid;gap:8px;margin-top:8px}
.edit-box textarea{min-height:80px}
.fileline{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.danger{background:var(--danger);color:#fff;border:none}
.ok{background:var(--ok);color:#062a12;border:none}
.status{display:inline-flex;align-items:center;gap:8px}
</style>
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
<div class="wrap">
<header><h1>Holiday Manager</h1><div class="badge"><span id="dateLabel">—</span></div></header>
<div class="controls">
<label>Theme:<select id="themeSel"><option value="dark">Dark</option><option value="light">Light</option><option value="floral">Floral</option><option value="sky">Sky Blue</option></select></label>
<a class="pill" href="/">Back to Timetable</a>
<button id="testBtn">Test Connection</button>
<span id="pubStatus" class="pill">—</span>
<button id="exportBtn">Export JSON</button>
<button id="importBtn">Import JSON</button><input type="file" id="importJson" accept="application/json" style="display:none">
</div>
<section class="card"><div class="hd"><span class="tag">Official Holidays</span></div><div class="bd"><div class="fileline"><label class="muted">Official proof PDF:</label><input type="file" id="officialProof" accept="application/pdf"><button id="saveOfficialProof">Save/Replace</button><button id="removeOfficialProof" class="danger">Remove</button><a id="officialProofLink" class="pill" href="#" target="_blank" style="display:none">View current PDF</a></div><div class="hint">Tip: keep file small (&lt;2MB).</div><form id="officialForm" style="margin-top:12px"><div class="row"><input type="text" id="offName" placeholder="Holiday name" required><input type="date" id="offStart" required title="Any year; month-day used"><input type="date" id="offEnd" title="Optional end (month-day)"></div><div class="edit-box"><textarea id="offDesc" placeholder="Description (shown on timetable)"></textarea><textarea id="offBullets" placeholder="Bullet points — one per line"></textarea></div><div class="row"><button type="submit">Add official holiday</button></div></form><div class="list" id="officialList"></div></div></section>
<section class="card"><div class="hd"><span class="tag">Special Holidays</span></div><div class="bd"><form id="specialForm"><div class="row"><input type="text" id="specName" placeholder="Holiday name" required><input type="date" id="specStart" required><input type="date" id="specEnd" placeholder="(optional)"></div><div class="edit-box"><textarea id="specDesc" placeholder="Description (shown on timetable)"></textarea><textarea id="specBullets" placeholder="Bullet points — one per line"></textarea><div class="fileline"><input type="file" id="specProof" accept="application/pdf"><span class="muted">PDF proof (optional).</span></div></div><div class="row"><button type="submit">Add special holiday</button></div></form><div class="list" id="specialList"></div></div></section>
<footer><p class="muted" style="font-size:13px">Official holidays repeat yearly using month-day. Special holidays are exact date ranges.</p></footer>
</div>
<script>
const $=s=>document.querySelector(s),LS_THEME='live-timetable-theme',LS_OFFICIAL='officialHolidays',LS_SPECIAL='specialHolidays',LS_OFFICIAL_PROOF='officialProofPdf',ALLOW=['krishnarawatethic@gmail.com'];
function ensureThemeDefault(){if(!localStorage.getItem(LS_THEME)){const h=new Date().getHours();localStorage.setItem(LS_THEME,(h>=6&&h<18)?'sky':'dark')}}
function applyTheme(){ensureThemeDefault();const t=localStorage.getItem(LS_THEME)||'dark';document.body.classList.remove('light','floral','sky');if(t!=='dark')document.body.classList.add(t);const sel=$('#themeSel');if(sel&&sel.value!==t)sel.value=t}
function fmtDateHuman(d){return d.toLocaleDateString('en-IN',{weekday:'long',year:'numeric',month:'long',day:'numeric'})}
function loadHolidays(){let official=[],special=[],proof=null;try{official=JSON.parse(localStorage.getItem(LS_OFFICIAL)||'[]');special=JSON.parse(localStorage.getItem(LS_SPECIAL)||'[]');proof=JSON.parse(localStorage.getItem(LS_OFFICIAL_PROOF)||'null')}catch(e){}return{official,special,proof}}
function saveHolidays({official,special,proof}){if(official)localStorage.setItem(LS_OFFICIAL,JSON.stringify(official));if(special)localStorage.setItem(LS_SPECIAL,JSON.stringify(special));if(proof!==undefined)localStorage.setItem(LS_OFFICIAL_PROOF,JSON.stringify(proof))}
function convertToMD(dateStr){if(!dateStr)return'';const p=dateStr.split('-');if(p.length===2)return dateStr;return p.length===3?p[1]+'-'+p[2]:''}
function readFileAsDataURL(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file)})}
function bulletsFromTextarea(val){return(val||'').split('\n').map(s=>s.trim()).filter(Boolean)}
function bulletsToTextarea(arr){return(arr||[]).join('\n')}
function fmtMD(md){if(!md)return'';const[m,d]=md.split('-');return d+'-'+m}
function fmtYMD(ymd){if(!ymd)return'';const[y,m,d]=ymd.split('-');return d+'-'+m+'-'+y}
function emailOf(u){return u&&(u.email||(u.app_metadata&&u.app_metadata.email))}
function isOwner(){const u=window.netlifyIdentity&&netlifyIdentity.currentUser();const e=emailOf(u);return !!(e&&ALLOW.includes(String(e).toLowerCase()))}
async function getToken(){const u=window.netlifyIdentity&&netlifyIdentity.currentUser();return u?await u.jwt():null}
async function publish(){const s=$('#pubStatus');try{s.textContent='Publishing...';const t=await getToken();if(!t){netlifyIdentity.open('login');s.textContent='Login required';return}const d=loadHolidays();const payload={officialProof:d.proof||null,officialHolidays:d.official||[],specialHolidays:d.special||[]};const r=await fetch('/.netlify/functions/holidays',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+t},body:JSON.stringify(payload)});if(!r.ok){s.textContent='Publish failed: '+r.status;return}s.textContent='Published ✓'}catch(e){s.textContent='Function error'}}
async function testConnection(){const s=$('#pubStatus');try{s.textContent='Testing...';const t=await getToken();const h=t?{'Authorization':'Bearer '+t}:{},r=await fetch('/.netlify/functions/holidays',{cache:'no-store',headers:h});s.textContent=r.ok?'Function OK':'Error '+r.status}catch(e){s.textContent='Function error'}}
function renderLists(){const{official,special,proof}=loadHolidays();const proofLink=$('#officialProofLink');if(proof&&proof.dataUrl){proofLink.style.display='';proofLink.href=proof.dataUrl;proofLink.textContent='View current PDF ('+(proof.name||'file')+')'}else{proofLink.style.display='none'}const offList=$('#officialList');offList.innerHTML='';official.forEach((h,idx)=>{const item=document.createElement('div');item.className='holiday-item';const range=h.end&&h.end!==h.start?fmtMD(h.start)+' – '+fmtMD(h.end):fmtMD(h.start);item.innerHTML='<div class="holiday-main"><div><b>'+h.name+'</b> <span class="pill">'+range+'</span></div>'+(h.desc?'<div class="muted" style="margin-top:4px">'+h.desc+'</div>':'')+((h.bullets&&h.bullets.length)?'<ul style="margin:6px 0 0 18px">'+h.bullets.map(li=>'<li>'+li+'</li>').join('')+'</ul>':'')+'</div><div class="holiday-actions"><button class="ok" data-type="official" data-idx="'+idx+'" data-act="edit">Edit</button><button class="danger" data-type="official" data-idx="'+idx+'" data-act="del">Delete</button></div>';offList.appendChild(item)});const specList=$('#specialList');specList.innerHTML='';special.forEach((h,idx)=>{const item=document.createElement('div');item.className='holiday-item';const range=h.end&&h.end!==h.start?fmtYMD(h.start)+' – '+fmtYMD(h.end):fmtYMD(h.start);const proofHtml=(h.proof&&h.proof.dataUrl)?'<a class="pill" href="'+h.proof.dataUrl+'" target="_blank">Proof PDF</a>':'<span class="pill muted">No proof</span>';item.innerHTML='<div class="holiday-main"><div><b>'+h.name+'</b> <span class="pill">'+range+'</span> '+proofHtml+'</div>'+(h.desc?'<div class="muted" style="margin-top:4px">'+h.desc+'</div>':'')+((h.bullets&&h.bullets.length)?'<ul style="margin:6px 0 0 18px">'+h.bullets.map(li=>'<li>'+li+'</li>').join('')+'</ul>':'')+'</div><div class="holiday-actions"><button class="ok" data-type="special" data-idx="'+idx+'" data-act="edit">Edit</button><button class="danger" data-type="special" data-idx="'+idx+'" data-act="del">Delete</button></div>';specList.appendChild(item)})}
function startEdit(type,idx){const data=loadHolidays();const listEl=type==='official'?$('#officialList'):$('#specialList');const row=listEl.children[idx];const h=type==='official'?data.official[idx]:data.special[idx];const editor=document.createElement('div');editor.className='edit-box';editor.innerHTML='<div class="row"><input type="text" id="e_name" value="'+(h.name||'')+'">'+(type==='official'?'<input type="date" id="e_s" value="'+new Date('2000-'+(h.start||'01-01')).toISOString().slice(0,10)+'" title="Any year ok; month-day used"><input type="date" id="e_e" value="'+new Date('2000-'+(h.end||h.start||'01-01')).toISOString().slice(0,10)+'" title="Any year ok; month-day used">':'<input type="date" id="e_s" value="'+h.start+'"><input type="date" id="e_e" value="'+(h.end||h.start)+'">')+'</div><textarea id="e_desc" placeholder="Description">'+(h.desc||'')+'</textarea><textarea id="e_bul" placeholder="Bullets — one per line">'+(bulletsToTextarea(h.bullets||[]))+'</textarea>'+(type==='special'?'<div class="fileline"><input type="file" id="e_proof" accept="application/pdf">'+((h.proof&&h.proof.dataUrl)?'<a class="pill" href="'+h.proof.dataUrl+'" target="_blank">Current proof</a>':'<span class="pill muted">No proof</span>')+'</div>':'')+'<div class="row"><button class="ok" id="e_save">Save</button><button class="danger" id="e_cancel">Cancel</button></div>';const main=row.querySelector('.holiday-main'),oldHTML=main.innerHTML;main.innerHTML='';main.appendChild(editor);editor.querySelector('#e_cancel').onclick=()=>{main.innerHTML=oldHTML};editor.querySelector('#e_save').onclick=async()=>{const name=editor.querySelector('#e_name').value.trim();let start=editor.querySelector('#e_s').value;let end=editor.querySelector('#e_e').value;const desc=editor.querySelector('#e_desc').value.trim();const bullets=bulletsFromTextarea(editor.querySelector('#e_bul').value);if(!name||!start)return;if(type==='official'){start=convertToMD(start);end=end?convertToMD(end):start;data.official[idx]={...h,name,start,end,desc,bullets}}else{let proof=h.proof||null;const file=editor.querySelector('#e_proof')?editor.querySelector('#e_proof').files[0]:null;if(file){if(file.size>2*1024*1024){alert('PDF too large (>2MB).');return}const dataUrl=await readFileAsDataURL(file);proof={name:file.name,type:file.type,dataUrl}}end=end||start;data.special[idx]={...h,name,start,end,desc,bullets,proof}}saveHolidays(data);renderLists();publish()}};
function bindUI(){document.getElementById('officialForm').addEventListener('submit',e=>{e.preventDefault();const name=$('#offName').value.trim();const start=convertToMD($('#offStart').value);const endRaw=$('#offEnd').value;const end=endRaw?convertToMD(endRaw):start;const desc=$('#offDesc').value.trim();const bullets=bulletsFromTextarea($('#offBullets').value);if(!name||!start)return;const data=loadHolidays();data.official.push({name,start,end,desc,bullets});saveHolidays(data);$('#offName').value='';$('#offStart').value='';$('#offEnd').value='';$('#offDesc').value='';$('#offBullets').value='';renderLists();publish()});
document.getElementById('specialForm').addEventListener('submit',async e=>{e.preventDefault();const name=$('#specName').value.trim();const start=$('#specStart').value;const end=$('#specEnd').value||start;const desc=$('#specDesc').value.trim();const bullets=bulletsFromTextarea($('#specBullets').value);if(!name||!start)return;let proof=null;const file=$('#specProof').files[0];if(file){if(file.size>2*1024*1024){alert('PDF too large (>2MB).');return}const dataUrl=await readFileAsDataURL(file);proof={name:file.name,type:file.type,dataUrl}}const data=loadHolidays();data.special.push({name,start,end,desc,bullets,proof});saveHolidays(data);$('#specName').value='';$('#specStart').value='';$('#specEnd').value='';$('#specDesc').value='';$('#specBullets').value='';$('#specProof').value='';renderLists();publish()});
document.getElementById('saveOfficialProof').addEventListener('click',async()=>{const file=$('#officialProof').files[0];if(!file){alert('Choose a PDF first.');return}if(file.size>2*1024*1024){alert('PDF too large (>2MB).');return}const dataUrl=await readFileAsDataURL(file);const data=loadHolidays();data.proof={name:file.name,type:file.type,dataUrl};saveHolidays(data);$('#officialProof').value='';renderLists();publish()});
document.getElementById('removeOfficialProof').addEventListener('click',()=>{const data=loadHolidays();data.proof=null;saveHolidays(data);renderLists();publish()});
document.getElementById('officialList').addEventListener('click',e=>{const btn=e.target.closest('button');if(!btn)return;const idx=+btn.getAttribute('data-idx');const type=btn.getAttribute('data-type');const act=btn.getAttribute('data-act');const data=loadHolidays();if(act==='del'){data.official.splice(idx,1);saveHolidays(data);renderLists();publish()}if(act==='edit'){startEdit(type,idx)}});
document.getElementById('specialList').addEventListener('click',e=>{const btn=e.target.closest('button');if(!btn)return;const idx=+btn.getAttribute('data-idx');const type=btn.getAttribute('data-type');const act=btn.getAttribute('data-act');const data=loadHolidays();if(act==='del'){data.special.splice(idx,1);saveHolidays(data);renderLists();publish()}if(act==='edit'){startEdit(type,idx)}});
document.getElementById('themeSel').addEventListener('change',e=>{localStorage.setItem(LS_THEME,e.target.value);applyTheme()});
document.getElementById('testBtn').addEventListener('click',testConnection);
document.getElementById('exportBtn').addEventListener('click',()=>{const d=loadHolidays();const blob=new Blob([JSON.stringify({officialHolidays:d.official,specialHolidays:d.special,officialProof:d.proof},null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='holidays-export.json';a.click();URL.revokeObjectURL(a.href)});
document.getElementById('importBtn').addEventListener('click',()=>$('#importJson').click());
document.getElementById('importJson').addEventListener('change',e=>{const f=e.target.files[0];if(!f)return;const fr=new FileReader();fr.onload=()=>{try{const j=JSON.parse(fr.result);const official=j.officialHolidays||[];const special=j.specialHolidays||[];const proof=j.officialProof||null;saveHolidays({official,special,proof});renderLists();publish()}catch{alert('Invalid JSON')}};fr.readAsText(f)});
const h=document.querySelector('h1');if(h){h.style.cursor='pointer';h.onclick=()=>{if(window.netlifyIdentity&&!netlifyIdentity.currentUser())netlifyIdentity.open('login')}}}
document.addEventListener('DOMContentLoaded',()=>{bindUI();applyTheme();document.getElementById('dateLabel').textContent=fmtDateHuman(new Date());renderLists();testConnection();if(window.netlifyIdentity){netlifyIdentity.on('init',()=>{});netlifyIdentity.on('login',()=>{renderLists()});netlifyIdentity.on('logout',()=>{});netlifyIdentity.init()}});
</script>
</body></html>
